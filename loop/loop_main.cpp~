/*
Czech_mate by Daniel
This file is part of Czech_mate.

Czech_mate is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License Version 2 as published by
the Free Software Foundation, 

Czech_mate is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Czech_mate.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "loop_main.h"

void loop_add(loop_t *a, std::string name, void(*b)()){
	loop_entry_t tmp;
	tmp.code = b;
	tmp.name = name;
	a->code.push_back(tmp);
}

void loop_run(loop_t *a, int settings){
	const unsigned long int code_size = a->code.size();
	if(CHECK_BIT(settings, LOOP_CODE_MT, 1)){
		std::vector<std::thread*> thread;
		for(unsigned long int i = 0;i < code_size;i++){
			thread.push_back(new std::thread(a->code[i].code));
		}
		for(unsigned long int i = 0;i < code_size;i++){
			thread[i]->join();
			delete thread[i];
			thread[i] = nullptr;
		}
	}else{
		for(unsigned long int i = 0;i < code_size;i++){
			const long double start_time = get_time();
			a->code[i].code();
			printf("ended loop code %lu (%s) from loop entity %s. TTL: %Lf\n", i, a->code[i].name.c_str(), a->name.c_str(), get_time()-start_time);
		}
	}
}

void loop_del(loop_t *a, void(*b)()){
	const unsigned long int code_size = a->code.size();
	for(unsigned long int i = 0;i < code_size;i++){
		if(a->code[i].code == b){
			a->code.erase(a->code.begin()+i);
			break;
		}
	}
}
